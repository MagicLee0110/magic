<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iOS Magic Pro - Multi-Profile</title>
    <style>
        :root {
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            --handwriting-font: "Cursive", "Bradley Hand", "Marker Felt", "Chalkboard SE", sans-serif;
            --main-gradient: linear-gradient(180deg, #000000 0%, #1a152e 40%, #000000 100%);
            --accent-color: #d4a017;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: var(--ios-font);
            overflow: hidden;
            background-color: #000;
            touch-action: none; 
        }

        /* --- 通知中心 --- */
        #notification-center {
            width: 100%; height: 100%;
            background: var(--main-gradient);
            position: relative;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .clock-container {
            text-align: center;
            padding-top: calc(env(safe-area-inset-top) + 60px);
            user-select: none;
            -webkit-user-select: none;
        }
        .time-text { font-size: 95px; font-weight: 200; margin: 0; letter-spacing: -2px; }
        .date-text { font-size: 19px; opacity: 0.9; }

        .notification-header { padding: 40px 25px 15px; font-size: 28px; font-weight: 600; }
        .notification-list { padding: 0 15px; }
        .notif-card {
            background: rgba(40, 40, 40, 0.4);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 24px; padding: 15px; margin-bottom: 12px;
            display: flex; flex-direction: column;
        }

        /* --- 九宮格 --- */
        .magic-area {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            z-index: 999;
            margin-bottom: 40px;
        }
        .magic-btn { width: 100%; height: 100%; background: transparent; }

        /* --- 備忘錄 --- */
        #memo-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff;
            display: none; flex-direction: column; z-index: 2000;
        }
        .memo-header { padding: calc(env(safe-area-inset-top) + 10px) 20px 10px; display: flex; justify-content: space-between; align-items: center; color: var(--accent-color); font-size: 17px; }
        .memo-content-area { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; }
        #handwritingNumber { font-family: var(--handwriting-font); font-size: 220px; font-weight: 500; color: rgba(255, 255, 255, 0.95); z-index: 2001; }
        #sketchCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2005; }

        /* --- 後台 (改良版) --- */
        #backstage-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1c1c1e; color: white;
            display: none; flex-direction: column; z-index: 3000;
            padding: calc(env(safe-area-inset-top) + 20px) 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .profile-section { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .profile-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .profile-tab { 
            padding: 8px 16px; background: #333; border-radius: 20px; font-size: 14px; white-space: nowrap;
            border: 2px solid transparent;
        }
        .profile-tab.active { background: var(--accent-color); color: black; border-color: #fff; }

        .config-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .profile-name-input { flex: 1; background: #2c2c2e; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 16px; }
        
        .grid-inputs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .grid-inputs input { background: #2c2c2e; border: 1px solid #444; color: white; padding: 15px 5px; border-radius: 8px; text-align: center; font-size: 18px; }

        .action-btns { display: flex; gap: 10px; }
        .btn { flex: 1; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; }
        .save-btn { background: var(--accent-color); color: black; }
        .add-btn { background: #32d74b; color: black; }
        .del-btn { background: #ff453a; color: white; flex: 0 0 60px; }

        .home-bar { position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); width: 140px; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 10px; z-index: 4000; }
    </style>
</head>
<body>

    <div id="notification-center">
        <div class="clock-container" id="clockZone" onclick="openMemo(null)">
            <div class="date-text" id="dateDisplay">1月3日 週六</div>
            <h1 class="time-text" id="timeDisplay">15:02</h1>
        </div>
        <div class="notification-header">通知中心</div>
        <div class="notification-list">
            <div class="notif-card">
                <div style="font-size:15px; font-weight:600; margin-bottom:4px;">提醒事項</div>
                <div style="font-size:14px; opacity:0.8;">晚上的表演記得檢查道具</div>
            </div>
        </div>

        <div class="magic-area">
            <div class="magic-btn" onclick="openMemo(0)"></div>
            <div class="magic-btn" onclick="openMemo(1)"></div>
            <div class="magic-btn" onclick="openMemo(2)"></div>
            <div class="magic-btn" onclick="openMemo(3)"></div>
            <div class="magic-btn" onclick="openMemo(4)"></div>
            <div class="magic-btn" onclick="openMemo(5)"></div>
            <div class="magic-btn" onclick="openMemo(6)"></div>
            <div class="magic-btn" onclick="openMemo(7)"></div>
            <div class="magic-btn" onclick="openMemo(8)"></div>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="memo-screen">
        <div class="memo-header">
            <span onclick="closeMemo()">＜ 備忘錄</span>
            <span style="font-weight:600;" onclick="closeMemo()">完成</span>
        </div>
        <div class="memo-content-area">
            <div id="handwritingNumber"></div>
            <canvas id="sketchCanvas"></canvas>
        </div>
        <div class="home-bar"></div>
    </div>

    <div id="backstage-screen">
        <div style="font-size:22px; font-weight:bold; margin-bottom:20px; text-align:center;">九宮格分組管理</div>
        
        <div class="profile-list" id="profileTabs">
            </div>

        <div class="profile-section">
            <div class="config-row">
                <input type="text" id="profileName" class="profile-name-input" placeholder="設定組名稱">
                <button class="del-btn" onclick="deleteCurrentProfile()">刪除</button>
            </div>
            
            <div class="grid-inputs" id="gridInputContainer">
                </div>
        </div>

        <div class="action-btns">
            <button class="add-btn" onclick="addNewProfile()">+ 新增分組</button>
            <button class="save-btn" onclick="saveAllAndClose()">儲存並關閉</button>
        </div>
    </div>

    <script>
        // --- 數據結構 ---
        // 預設資料
        let appData = {
            activeIdx: 0,
            profiles: [
                { name: "預設組", values: ["198", "297", "396", "495", "594", "693", "792", "891", "99"] }
            ]
        };

        // 從 LocalStorage 讀取
        const saved = localStorage.getItem('magicProData');
        if (saved) appData = JSON.parse(saved);

        // --- 初始化後台 UI ---
        function renderBackstage() {
            const tabs = document.getElementById('profileTabs');
            const grid = document.getElementById('gridInputContainer');
            const current = appData.profiles[appData.activeIdx];

            // 渲染標籤
            tabs.innerHTML = '';
            appData.profiles.forEach((p, i) => {
                const tab = document.createElement('div');
                tab.className = `profile-tab ${i === appData.activeIdx ? 'active' : ''}`;
                tab.textContent = p.name;
                tab.onclick = () => switchProfile(i);
                tabs.appendChild(tab);
            });

            // 渲染名稱
            document.getElementById('profileName').value = current.name;

            // 渲染 9 宮格
            grid.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = current.values[i] || "";
                input.oninput = (e) => { current.values[i] = e.target.value; };
                grid.appendChild(input);
            }
        }

        // 監聽名稱修改
        document.getElementById('profileName').oninput = (e) => {
            appData.profiles[appData.activeIdx].name = e.target.value;
            renderBackstage(); // 即時更新標籤名稱
        };

        function switchProfile(idx) {
            appData.activeIdx = idx;
            renderBackstage();
        }

        function addNewProfile() {
            appData.profiles.push({
                name: "新分組 " + (appData.profiles.length + 1),
                values: ["", "", "", "", "", "", "", "", ""]
            });
            appData.activeIdx = appData.profiles.length - 1;
            renderBackstage();
        }

        function deleteCurrentProfile() {
            if (appData.profiles.length <= 1) return alert("至少需保留一個設定組");
            if (confirm("確定刪除此組設定？")) {
                appData.profiles.splice(appData.activeIdx, 1);
                appData.activeIdx = 0;
                renderBackstage();
            }
        }

        function saveAllAndClose() {
            localStorage.setItem('magicProData', JSON.stringify(appData));
            document.getElementById('backstage-screen').style.display = 'none';
        }

        // --- 長按邏輯 ---
        let pressTimer;
        document.getElementById('clockZone').addEventListener('touchstart', () => {
            pressTimer = setTimeout(() => {
                renderBackstage();
                document.getElementById('backstage-screen').style.display = 'flex';
            }, 1500);
        });
        document.getElementById('clockZone').addEventListener('touchend', () => clearTimeout(pressTimer));

        // --- 畫布邏輯 ---
        const canvas = document.getElementById('sketchCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.strokeStyle = "rgba(255, 255, 255, 0.95)";
            ctx.lineWidth = 10;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
        }
        window.addEventListener('resize', initCanvas);
        initCanvas();

        function startDrawing(e) { drawing = true; draw(e); }
        function stopDrawing() { drawing = false; ctx.beginPath(); }
        function draw(e) {
            if (!drawing) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
        canvas.addEventListener('touchend', stopDrawing);

        // --- 備忘錄開關 ---
        function openMemo(index) {
            document.getElementById('notification-center').style.display = 'none';
            document.getElementById('memo-screen').style.display = 'flex';
            
            const numDisplay = document.getElementById('handwritingNumber');
            if (index === null) {
                numDisplay.style.display = 'none';
                canvas.style.display = 'block';
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            } else {
                const currentValues = appData.profiles[appData.activeIdx].values;
                numDisplay.textContent = currentValues[index];
                numDisplay.style.display = 'block';
                canvas.style.display = 'none';
            }
        }

        function closeMemo() {
            document.getElementById('memo-screen').style.display = 'none';
            document.getElementById('notification-center').style.display = 'flex';
        }

        // --- 時鐘更新 ---
        function updateClock() {
            const now = new Date();
            document.getElementById('timeDisplay').textContent = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const weekDays = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
            document.getElementById('dateDisplay').textContent = `${now.getMonth() + 1}月${now.getDate()}日 ${weekDays[now.getDay()]}`;
        }
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>
