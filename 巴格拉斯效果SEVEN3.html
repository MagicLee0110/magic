<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <style>
    /* 回歸原本的清爽白底設定 */
    body { 
        display: flex; 
        justify-content: center; 
        background-color: #f2f2f2; 
        align-items: center; 
        height: 100vh; 
        margin: 0; 
        padding: 0; 
        font-family: "Microsoft JhengHei", sans-serif; 
    }
    
    #ebook-container { text-align: center; padding: 20px; width: 100%; max-width: 400px; }
    
    /* 電子書頁面：回歸純白，並固定高度 */
    #ebook-page { 
        background-color: #fff; 
        padding: 25px; 
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); 
        position: relative; 
        height: 600px; 
        border-radius: 8px; 
        transition: 0.3s; 
        box-sizing: border-box;
    }
    
    #ebook-header { 
        text-align: center; 
        font-size: 20px; 
        margin-bottom: 20px; 
        border-bottom: 1px solid #eee; 
        padding-bottom: 10px; 
        font-weight: bold; 
        color: #333; 
    }

    /* 輸入區塊 */
    #inputSection { background-color: #f9f9f9; padding: 10px; border-radius: 8px; }
    .btn-group { display: flex; justify-content: center; flex-wrap: wrap; margin-bottom: 5px; }
    .small-button { 
        width: 44px; 
        height: 42px; 
        font-size: 20px; 
        margin: 2px; 
        cursor: pointer; 
        border: 1px solid #ccc; 
        border-radius: 6px; 
        background: white; 
    }
    .small-button:active { background: #007bff; color: white; }
    
    input { 
        width: 85%; 
        padding: 10px; 
        border: 1px solid #ccc; 
        border-radius: 6px; 
        margin: 10px 0; 
        text-align: center; 
        font-size: 16px; 
        background: #fff; 
        font-weight: bold; 
    }
    
    .calc-btn { 
        background-color: #007bff; 
        color: #fff; 
        border: none; 
        padding: 12px 30px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 18px; 
        width: 80%; 
        margin-top: 10px; 
    }
    
    .clear-button { 
        background: none; 
        color: #888; 
        border: 1px solid #888; 
        padding: 4px 10px; 
        border-radius: 4px; 
        font-size: 12px; 
        cursor: pointer; 
        margin-top: 15px; 
    }

    /* 故事區塊 */
    #article { display: none; text-align: left; line-height: 1.8; font-size: 16px; color: #333; animation: fadeIn 0.5s; height: 420px; overflow-y: auto; }
    
    /* 固定在頁面正下方的頁數 */
    #page-number { 
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        font-size: 12px; 
        text-align: center; 
        font-weight: bold; 
        color: #555; 
    }
    
    /* 翻頁熱區 */
    #prevPageButton, #nextPageButton { 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        width: 25%; 
        background: transparent; 
        border: none; 
        cursor: pointer; 
        z-index: 10; 
        font-size: 0; 
        outline: none; 
        -webkit-tap-highlight-color: transparent; 
    }
    #prevPageButton { left: 0; }
    #nextPageButton { right: 0; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
 </style>
</head>
<body>
  <div id="ebook-container">
    <div id="ebook-page">
      <div id="ebook-header"><strong>Chapter3-我與大衛的故事</strong></div>
      
      <div id="inputSection">
        <label><strong>請輸入撲克牌：</strong></label>
        <div class="btn-group">
          <button class="small-button" onclick="chooseCard('黑桃')">♠</button>
          <button class="small-button" onclick="chooseCard('紅心')">♥</button>
          <button class="small-button" onclick="chooseCard('方塊')">♦</button>
          <button class="small-button" onclick="chooseCard('梅花')">♣</button>
        </div>
        <div class="btn-group">
          <button class="small-button" onclick="chooseCard('A')">A</button>
          <button class="small-button" onclick="chooseCard('2')">2</button>
          <button class="small-button" onclick="chooseCard('3')">3</button>
          <button class="small-button" onclick="chooseCard('4')">4</button>
          <button class="small-button" onclick="chooseCard('5')">5</button>
          <button class="small-button" onclick="chooseCard('6')">6</button>
          <button class="small-button" onclick="chooseCard('7')">7</button>
          <button class="small-button" onclick="chooseCard('8')">8</button>
          <button class="small-button" onclick="chooseCard('9')">9</button>
          <button class="small-button" onclick="chooseCard('10')">10</button>
          <button class="small-button" onclick="chooseCard('J')">J</button>
          <button class="small-button" onclick="chooseCard('Q')">Q</button>
          <button class="small-button" onclick="chooseCard('K')">K</button>
        </div>
        <input type="text" id="cardInput" readonly placeholder="點選按鈕">
        
        <label><strong>請輸入數字：</strong></label>
        <div class="btn-group">
          <button class="small-button" onclick="chooseNumber('1')">1</button>
          <button class="small-button" onclick="chooseNumber('2')">2</button>
          <button class="small-button" onclick="chooseNumber('3')">3</button>
          <button class="small-button" onclick="chooseNumber('4')">4</button>
          <button class="small-button" onclick="chooseNumber('5')">5</button>
          <button class="small-button" onclick="chooseNumber('6')">6</button>
          <button class="small-button" onclick="chooseNumber('7')">7</button>
          <button class="small-button" onclick="chooseNumber('8')">8</button>
          <button class="small-button" onclick="chooseNumber('9')">9</button>
          <button class="small-button" onclick="chooseNumber('0')">0</button>
        </div>
        <input type="number" id="number" readonly placeholder="點選數字">
        <br>
        <button class="calc-btn" onclick="calculate()"><strong>啟動故事</strong></button>
        <br>
        <button class="clear-button" onclick="clearInput()">重新輸入</button>
      </div>

      <div id="article">
        <div id="articleContent"></div>
      </div>

      <div id="page-number"><strong>-第 <span id="currentPageNumber">37</span> 頁-</strong></div>
      
      <button id="prevPageButton" onclick="previousPage()" style="display:none">Prev</button>
      <button id="nextPageButton" onclick="nextPage()" style="display:none">Next</button>
    </div>
  </div>

<script>
    var baseStack = [
        {suit:"梅花",number:"4"},{suit:"紅心",number:"2"},{suit:"方塊",number:"7"},{suit:"梅花",number:"3"},
        {suit:"紅心",number:"4"},{suit:"方塊",number:"6"},{suit:"黑桃",number:"A"},{suit:"紅心",number:"5"},
        {suit:"黑桃",number:"9"},{suit:"黑桃",number:"2"},{suit:"紅心",number:"Q"},{suit:"方塊",number:"3"},
        {suit:"梅花",number:"Q"},{suit:"紅心",number:"8"},{suit:"黑桃",number:"6"},{suit:"黑桃",number:"5"},
        {suit:"紅心",number:"9"},{suit:"梅花",number:"K"},{suit:"方塊",number:"2"},{suit:"紅心",number:"J"},
        {suit:"黑桃",number:"3"},{suit:"黑桃",number:"8"},{suit:"紅心",number:"6"},{suit:"梅花",number:"10"},
        {suit:"方塊",number:"5"},{suit:"方塊",number:"K"},{suit:"梅花",number:"2"},{suit:"紅心",number:"3"},
        {suit:"方塊",number:"8"},{suit:"梅花",number:"5"},{suit:"黑桃",number:"K"},{suit:"方塊",number:"J"},
        {suit:"梅花",number:"8"},{suit:"黑桃",number:"10"},{suit:"紅心",number:"K"},{suit:"梅花",number:"J"},
        {suit:"黑桃",number:"7"},{suit:"紅心",number:"10"},{suit:"方塊",number:"A"},{suit:"黑桃",number:"4"},
        {suit:"紅心",number:"7"},{suit:"方塊",number:"4"},{suit:"梅花",number:"A"},{suit:"梅花",number:"9"},
        {suit:"黑桃",number:"J"},{suit:"方塊",number:"Q"},{suit:"梅花",number:"7"},{suit:"黑桃",number:"Q"},
        {suit:"方塊",number:"10"},{suit:"梅花",number:"6"},{suit:"紅心",number:"A"},{suit:"方塊",number:"9"}
    ];

    var allDecks = {};
    for (var i = 0; i < 13; i++) {
        var key = String.fromCharCode(65 + i);
        var offset = i * 4;
        allDecks[key] = baseStack.slice(offset).concat(baseStack.slice(0, offset));
    }

    var globalResultString = "";
    var currentPage = 1;
    var storyBookPage = 37;
    var userNumInput = 0;

    function chooseCard(v) { document.getElementById("cardInput").value += v; }
    function chooseNumber(v) { document.getElementById("number").value += v; }
    function clearInput() { document.getElementById("cardInput").value = ""; document.getElementById("number").value = ""; }

    function calculate() {
        var cardVal = document.getElementById("cardInput").value;
        userNumInput = parseInt(document.getElementById("number").value);
        var parsed = parseCard(cardVal);

        if (!parsed || isNaN(userNumInput)) { alert("請完整輸入！"); return; }

        let found = false;
        for (let key in allDecks) {
            let deck = allDecks[key];
            let pos = getPos(deck, parsed);

            if (pos + 2 === userNumInput) {
                setCalcResult(key, "確認包含那兩張廣告牌後", "背面向下一張張往下發", userNumInput);
                found = true; break;
            }
            if (pos === userNumInput) {
                setCalcResult(key, "拿掉那兩張廣告牌後", "背面向下一張張往下發", userNumInput);
                found = true; break;
            }
            if (55 - pos === userNumInput) {
                setCalcResult(key, "確認包含那兩張鬼牌後", "正面朝上一張張數起", userNumInput);
                found = true; break;
            }
            if (53 - pos === userNumInput) {
                setCalcResult(key, "拿掉那兩張鬼牌後", "正面朝上一張張數起", userNumInput);
                found = true; break;
            }
        }

        if(!found) { alert("此組合目前13副牌無法覆蓋，請調整數字。"); return; }

        document.getElementById("inputSection").style.display = "none";
        document.getElementById("prevPageButton").style.display = "block";
        document.getElementById("nextPageButton").style.display = "block";
        showArticle();
    }

    function setCalcResult(k, action, direction, n) {
        var locs = {"A":"窗台上","B":"書櫃中間","C":"酒櫃裡","D":"衣櫃裡","E":"手提包內","F":"口袋內","G":"椅子底下","H":"桌上的盒子內","I":"招財貓後面","J":"桌子下面的抽屜","K":"桌子側邊的抽屜","L":"電視正下方的抽屜","M":"電視正上方的櫃子"};
        globalResultString = `起身走到${locs[k]}拿出一副撲克牌並且把牌交給我，大衛請我把牌取出，${action}，讓我從${direction}到第 ${n} 張`;
        storyBookPage = k.charCodeAt(0) - 64 + 30; 
    }

    function getPos(deck, t) {
        for(var i=0; i<deck.length; i++) {
            if(deck[i].suit === t.suit && deck[i].number === t.number) return i + 1;
        }
        return -1;
    }

    function parseCard(input) {
        var m = input.match(/^(黑桃|紅心|方塊|梅花)([2-9]|10|A|J|Q|K)$/);
        return m ? { suit: m[1], number: m[2] } : null;
    }

    function showArticle() {
        var content = document.getElementById("articleContent");
        var header = document.getElementById("ebook-header");
        var pgNumDiv = document.getElementById("page-number");
        var pgDisp = document.getElementById("currentPageNumber");

        if (currentPage === 0) {
            content.innerHTML = `<h1><br><br><br>Chapter3<br>我與大衛的故事</h1>`;
            header.style.display = "none"; pgNumDiv.style.display = "none";
        } else if (currentPage === 1) {
            content.innerHTML = `<p><br>大衛·巴格拉斯（David Berglas）</p><p>"聖殿級的ACAAN"</p><img src="book1.jpg" style="width:100%; border-radius:5px;"><p><br>ACAAN 是魔術師終其一生追求的聖杯。在大衛的世界裡，這不只是魔術，更是純粹的奇蹟。</p>`;
            header.style.display = "block"; pgNumDiv.style.display = "block";
            pgDisp.innerText = storyBookPage - 1; 
        } else if (currentPage === 2) {
            content.innerHTML = `
                <p><br>故事發生在1976年，當時我已認識大衛多年，但始終沒有機會能看到那個效果！</p>
                <p>直到有一天，大衛邀請我去他家裡作客。記得當時我們聊得正愉快時...大衛突然讓我隨意說出一張牌，和一個 1-52 之間的數字。</p>
                <p>我說了方塊5，32。</p>
                <p>大衛先是跟我分享了一個有趣的小故事後，便緩緩起身，${globalResultString}，數到最後，翻開那一張牌...</p>
                <p>你知道的...那張正是「方塊5」！！！</p>
                <p>我永遠忘不了那天!!! 多希望你們當時也能在場見證，這就是我親眼見證到的傳說中的 "巴格拉斯效果"。</p>
            `;
            header.style.display = "block"; pgNumDiv.style.display = "block";
            pgDisp.innerText = storyBookPage; 
        } else if (currentPage === 3) {
            content.innerHTML = `<p><br><br><br><br><center>".........我永遠忘不了那個男人........永遠......!!!"</center></p>`;
            header.style.display = "block"; pgNumDiv.style.display = "block";
            pgDisp.innerText = storyBookPage + 1; 
        } else if (currentPage === 4) {
            content.innerHTML = `<h1><br><br><br>Chapter4<br>MY ACAAN</h1>`;
            header.style.display = "none"; pgNumDiv.style.display = "none";
        }
        document.getElementById("article").style.display = "block";
    }

    function previousPage() { if (currentPage > 0) { currentPage--; showArticle(); } }
    function nextPage() { if (currentPage < 4) { currentPage++; showArticle(); } }

    document.addEventListener("keydown", e => { if (e.keyCode == 123 || (e.ctrlKey && e.key.toLowerCase() === 'u')) e.preventDefault(); });
    document.addEventListener("contextmenu", e => e.preventDefault());
</script>
</body>
</html>
